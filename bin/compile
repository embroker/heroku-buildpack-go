#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

unset GIT_DIR

# Go releases for Darwin beginning with 1.2rc1
# have included more than one build, depending
# on the specific version of Mac OS X. Try to
# account for that, but don't try too hard.
# This doesn't affect Heroku builds, it's only
# for testing on Darwin systems.
platext() {
    case $1 in
    go1.0*|go1.1beta*|go1.1rc*|go1.1|go1.1.*) return ;;
    esac
    case $(uname|tr A-Z a-z) in
    darwin) printf %s -osx10.8 ;;
    esac
}

# Go releases have moved to a new URL scheme
# starting with Go version 1.2.2. Return the old
# location for known old versions and the new
# location otherwise.
urlfor() {
    ver=$1
    file=$2
    case $ver in
    go1.0*|go1.1beta*|go1.1rc*|go1.1|go1.1.*|go1.2beta*|go1.2rc*|go1.2|go1.2.1)
        echo http://go.googlecode.com/files/$file
        ;;
    *)
        echo https://storage.googleapis.com/golang/$file
        ;;
    esac
}

mkdir -p "$1" "$2"
BUILD_DIR=$(cd "$1/" && pwd)
echo BUILD_DIR $BUILD_DIR
CACHE_DIR=$(cd "$2/" && pwd)
echo CACHE_DIR $CACHE_DIR
BP_DIR=$(cd "$(dirname $0)/.." && pwd)
echo BP_DIR $BP_DIR

source $BP_DIR/lib/environment.sh
source $BP_DIR/lib/binaries.sh
source $BP_DIR/lib/json.sh

step() {
    echo "-----> $@"
}

start() {
    echo -n "-----> $@... "
}

finished() {
    echo "done"
}

GO_PROJECT_NAME=$(read_json "$BUILD_DIR/Godeps/Godeps.json" ".ImportPath")
echo GO_PROJECT_NAME $GO_PROJECT_NAME
GO_VERSION=$(read_json "$BUILD_DIR/Godeps/Godeps.json" ".GoVersion")
echo GO_VERSION $GO_VERSION

GO_FILE=${GOFILE:-$GO_VERSION.$(uname|tr A-Z a-z)-amd64$(platext $GO_VERSION).tar.gz}
echo GO_FILE $GO_FILE
GO_URL=${GOURL:-$(urlfor $GO_VERSION $GO_FILE)}
echo GO_URL $GO_URL

# install Go or get it from cache
GO_CACHE_DIR=$CACHE_DIR/go
GO_DIR=$GO_CACHE_DIR/$GO_VERSION/
if test -d $GO_DIR
then
    step "Using $GO_VERSION from cache"
else
    rm -rf $GO_CACHE_DIR/* # clear Go cache
    mkdir -p "$GO_CACHE_DIR"
    cd $GO_CACHE_DIR
    start "Installing $GO_VERSION"
		GO_TAR="go.tar.gz"
		echo GO_URL $GO_URL
		curl $GO_URL --silent --fail --retry 5 --retry-max-time 15  -o $GO_TAR || (echo "Unable to download node $GO_VERSION; does it exist?" && false)
		tar zxf $GO_TAR
		rm -f $GO_TAR
		mv go $GO_VERSION
    finished
fi

mkdir -p $BUILD_DIR/bin
GOBIN=$BUILD_DIR/bin export GOBIN
export GOROOT=$GO_DIR
export GOPATH=$BUILD_DIR/.heroku/go
export PATH=$GOROOT/bin:$GOBIN:$PATH

p=$GOPATH/src/$GO_PROJECT_NAME
mkdir -p $p
cp -R $BUILD_DIR/* $p
cd $p

# build server
source ./buildserver.sh

# read and resolve Node version
NODE_VERSION=$(read_json "$BUILD_DIR/client/heroku.json" ".node")
echo ".node (heroku.json):  ${NODE_VERSION:-unspecified}"

if nodejs_version_needs_resolution "$NODE_VERSION"; then
	echo "Resolving node NODE_VERSION ${NODE_VERSION:-(latest stable)} via semver.io..."
	NODE_VERSION=$(curl --silent --get --retry 5 --retry-max-time 15 --data-urlencode "range=${NODE_VERSION}" https://semver.herokuapp.com/node/resolve)
fi

NODE_URL="http://s3pository.heroku.com/node/v$NODE_VERSION/node-v$NODE_VERSION-$OS-$CPU.tar.gz"

# install Node or get it from cache
NODE_CACHE_DIR=$CACHE_DIR/node/
NODE_DIR=$NODE_CACHE_DIR/$NODE_VERSION/
if test -d $NODE_CACHE_DIR
then
    step "Using $NODE_VERSION from cache"
else
    rm -rf $NODE_CACHE_DIR/* # clear Node cache
    mkdir -p "$NODE_CACHE_DIR"
    cd $NODE_CACHE_DIR
    start "Installing $NODE_VERSION"
		NODE_TAR="node.tar.gz"
		curl $NODE_URL --silent --fail --retry 5 --retry-max-time 15 -o $NODE_TAR || (echo "Unable to download node $NODE_VERSION; does it exist?" && false)
		tar xzf $NODE_TAR
		mv node-v$NODE_VERSION-$OS-$CPU $NODE_VERSION
    finished
	chmod +x $NODE_DIR/bin/*
	npm install grunt-cli --save-dev -g
fi

export PATH="$NODE_DIR/bin":$PATH

cd $BUILD_DIR
# build client
./buildclient heroku

rm -rf $BUILD_DIR/.heroku

mkdir -p $BUILD_DIR/.profile.d
echo 'PATH=$PATH:$HOME/bin' > $BUILD_DIR/.profile.d/go.sh
cp $BP_DIR/vendor/concurrency.sh $BUILD_DIR/.profile.d/